varnishtest "Check that we fail to start with erroneous -a/-b arguments"

server s1 {}
varnish v1 -vcl+backend {} -start
varnish v1 -stop

# Duplicate -a arguments
shell -err -expect "have same address" {
	varnishd -d -a 127.0.0.1:${v1_port} -a 127.0.0.1:${v1_port} \
	    -b localhost:80
}

# -a bad protocol specs
shell -err -expect "Too many sub-arguments" \
	"varnishd -a 127.0.0.1:80000,PROXY,FOO -d 2>&1"
shell -err -expect "Too many sub-arguments" \
	"varnishd -a 127.0.0.1:80000,HTTP/1,FOO -d 2>&1"

# This requires non-local binds to be disabled.  If you see this fail
# and are on Linux, ensure /proc/net/ipv4/ip_nonlocal_bind is set to 0.

# All bad listen addresses
shell -err -expect "Error: Could not get socket" {
	varnishd -F -a "${bad_ip}:0" -b '***' -n ${tmpdir} 2>&1
}

# old style address list
shell -err -expect "Unknown protocol" {
	varnishd -F -a "127.0.0.1:0,${bad_ip}:0" -b '***' -n ${tmpdir} 2>&1
}
