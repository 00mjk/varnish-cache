varnishtest "varnishlog coverage"

server s1 {
	rxreq
	txresp
} -start

varnish v1 -vcl+backend {} -start

process p1 "exec varnishlog -n ${v1_name} -g raw -k 1" -start
process p2 {
	exec varnishlog -n ${v1_name} -g raw -k 1 -w ${tmpdir}/p2/output -A
} -start
process p3 {
	exec varnishlog -n ${v1_name} -g raw -k 1 -w ${tmpdir}/p3/output.bin
} -start
shell -expect "Usage: varnishlog <options>" \
	"varnishlog -h"
shell -expect "Copyright (c) 2006 Verdens Gang AS" \
	"varnishlog -V"
shell -err -expect "Usage: varnishlog <options>" \
	"varnishlog extra"
shell -err -expect "Missing -w option" \
	"varnishlog -D"
shell -err -expect "-L: Range error" \
	"varnishlog -L 0"
shell -err -expect {-i: "foo" matches zero tags} \
	"varnishlog -i foo"
shell -err -expect {-i: "Resp" is ambiguous} \
	"varnishlog -i Resp"
shell -err -expect {-I: "foo" matches zero tags} \
	"varnishlog -I foo:bar"
shell -err -expect {-I: "Resp" is ambiguous} \
	"varnishlog -I Resp:bar"
shell -err -expect {-I: Regex error at position 4 (missing ))} \
	{varnishlog -I "(foo"}
shell -err -expect {-x: Syntax error in "**"} \
	{varnishlog -x "**"}
shell -err -expect {-X: Syntax error in "**"} \
	{varnishlog -X "**:bar"}
process p1 -wait
shell {grep -q "0 CLI" ${p1_out}}
process p2 -wait
shell {grep -q "0 CLI" ${p2_dir}/output}
process p3 -wait
shell -expect "0 CLI" {varnishlog -g raw -r ${p3_dir}/output.bin}
