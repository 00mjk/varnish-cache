varnishtest "Test VSL query operators"

server s1 {
	rxreq
	txresp
} -start

varnish v1 -vcl+backend {
} -start

logexpect l1 -v v1

client c1 {
	txreq -hdr "Foo: bar"
	rxresp
	expect resp.status == 200
} -run

# Test 'eq' operator
logexpect l1 -d 1 -g vxid -q "Begin eq 'req 1000'" {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test 'ne' operator
logexpect l1 -d 1 -g vxid -q "ReqProtocol ne 'HTTP/1.0'" {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '==' operator on integers
logexpect l1 -d 1 -g vxid -q "RespStatus == 200" {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '==' operator on floats
logexpect l1 -d 1 -g vxid -q "RespStatus == 200." {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '!=' operator on integers
logexpect l1 -d 1 -g vxid -q "RespStatus != 503" {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '!=' operator on floats
logexpect l1 -d 1 -g vxid -q "RespStatus != 503." {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '<' operator on integers
logexpect l1 -d 1 -g vxid -q "RespStatus < 201" {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '<' operator on floats
logexpect l1 -d 1 -g vxid -q "RespStatus < 201." {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '>' operator on integers
logexpect l1 -d 1 -g vxid -q "RespStatus > 199" {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run

# Test '>' operator on floats
logexpect l1 -d 1 -g vxid -q "RespStatus > 199." {
	expect * *	Begin	req
	expect * =	ReqEnd
	expect * =	End
} -run
