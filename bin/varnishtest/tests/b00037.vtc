varnishtest "Error on multiple Host headers"

varnish v1 -vcl {backend be none;} -start

client c1 {
	txreq -hdr "Host: foo" -hdr "Host: bar"
	rxresp
	expect resp.status == 400
} -run

varnish v1 -vsl_catchup
varnish v1 -expect client_req_400 == 1

client c1 {
	txreq -method POST -hdr "Content-Length: 12" -bodylen 12
	rxresp
	expect resp.status == 400
} -run

varnish v1 -vsl_catchup
varnish v1 -expect client_req_400 == 2

varnish v1 -cliok "param.set feature +http2"

client c2 {
	stream 7 {
		txreq -hdr host foo -hdr host bar
		rxresp
		expect resp.status == 400
	} -run
} -run

varnish v1 -vsl_catchup
varnish v1 -expect client_req_400 == 3

client c3 {
	stream 3 {
		txreq -req POST -hdr content-length 12 -hdr content-length 13 -body request
		rxrst
	} -run
} -run

varnish v1 -vsl_catchup
varnish v1 -expect client_req_400 == 4
