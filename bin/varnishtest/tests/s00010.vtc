varnishtest "client h1 send timeouts"

server s1 {
	rxreq
	txresp -bodylen 100000
} -start

varnish v1 -vcl+backend {
	import debug;

	sub vcl_deliver {
		debug.sndbuf(128b);
	}
} -start

varnish v1 -cliok "param.set send_timeout 1"

logexpect l1 -v v1 {
	expect * * Debug "Hit total send timeout"
} -start

client c1 -rcvbuf 128 {
	txreq
	rxresphdrs
	# keep the session open for 2 seconds
	delay 2
} -run

logexpect l1 -wait

feature SO_RCVTIMEO_WORKS
varnish v1 -cliok "param.set idle_send_timeout 1"
varnish v1 -cliok "param.reset send_timeout"

logexpect l2 -v v1 {
	expect * * Debug "Hit idle send timeout"
} -start

client c2 -rcvbuf 128 {
	txreq
	rxresphdrs
	# keep the session open for 2 seconds
	delay 2
} -run

logexpect l2 -wait
